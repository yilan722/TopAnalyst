# 报告格式锁定系统

## 📋 概述
本系统用于锁定和监控股票估值报告的格式，确保所有生成的报告都符合CoreWeave PDF的格式标准。

## 🔒 格式锁定机制

### 1. 格式标准文档
- **文件**: `REPORT_FORMAT_STANDARD.md`
- **作用**: 定义固定的格式要求，禁止修改
- **内容**: 表格格式、图表格式、内容要求等

### 2. 代码层面锁定
- **文件**: `app/api/generate-report-perplexity/route.ts`
- **锁定内容**:
  - 每个部分恰好3个表格
  - 每个部分恰好3个图表
  - 标准HTML格式示例
  - 必需的CSS类名

### 3. 验证机制
- **文件**: `app/api/generate-report-perplexity/route.ts` 中的 `validateReportFormat` 函数
- **作用**: 每次生成报告后自动验证格式
- **检查项**: 表格数量、图表数量、内容长度、HTML结构

## 🛠️ 使用方法

### 基本命令

```bash
# 检查格式锁定状态
npm run format:check

# 创建格式锁定
npm run format:lock

# 测试报告格式
npm run format:test <report-file.json>

# 扫描报告文件
npm run format:scan

# 启动持续监控
npm run format:monitor
```

### 详细说明

#### 1. 检查格式锁定状态
```bash
npm run format:check
```
- 检查prompt文件中的格式要求是否完整
- 检查HTML格式示例是否存在
- 检查标准文档是否存在
- 检查测试脚本是否存在

#### 2. 创建格式锁定
```bash
npm run format:lock
```
- 创建 `FORMAT_LOCK.json` 文件
- 记录锁定时间和配置
- 标记关键文件为锁定状态

#### 3. 测试报告格式
```bash
npm run format:test sample-report.json
```
- 验证报告是否符合格式标准
- 检查表格数量（每个部分3个）
- 检查图表数量（每个部分3个）
- 检查内容长度（每个部分500+字）
- 检查HTML结构是否正确

#### 4. 扫描报告文件
```bash
npm run format:scan
```
- 扫描项目中的所有报告文件
- 显示文件路径列表
- 用于批量检查

#### 5. 启动持续监控
```bash
npm run format:monitor
```
- 每5分钟自动检查一次格式
- 监控所有报告文件
- 记录日志到 `logs/format-monitor.log`
- 超过阈值时发出警告

## 📊 格式标准

### 表格要求
- 每个部分恰好3个表格
- 使用标准HTML格式：`<table class="metric-table">`
- 包含正确的表头：`<thead><tr><th>...</th></tr></thead>`
- 包含正确的数据行：`<tbody><tr><td>...</td></tr></tbody>`

### 图表要求
- 每个部分恰好3个图表
- 使用标准HTML格式：`<div class="chart-container">`
- 包含图表标题：`<h4>图表标题</h4>`
- 包含图表内容：`<div class="chart-placeholder">...</div>`

### 内容要求
- 每个部分最少500字
- 四个部分内容均衡
- 数据与文字分析匹配
- 使用正确的CSS类名

## ⚠️ 重要提醒

### 1. 严禁修改
- 任何人不得修改格式标准文档
- 不得修改prompt中的格式要求
- 不得修改HTML格式示例
- 不得修改验证逻辑

### 2. 定期检查
- 每月运行一次格式检查
- 每次部署前验证格式
- 发现问题立即修复

### 3. 问题报告
- 发现格式问题立即报告
- 记录问题详情和修复过程
- 更新格式标准文档

## 🔧 故障排除

### 常见问题

#### 1. 表格数量不正确
**症状**: 报告中的表格数量不是3个
**原因**: AI没有严格按照prompt要求生成
**解决**: 检查prompt中的格式要求是否完整

#### 2. 图表数量不正确
**症状**: 报告中的图表数量不是3个
**原因**: AI没有严格按照prompt要求生成
**解决**: 检查prompt中的图表格式要求

#### 3. HTML格式错误
**症状**: 表格或图表格式不正确
**原因**: AI没有使用正确的HTML格式
**解决**: 检查prompt中的HTML格式示例

#### 4. 内容过短
**症状**: 某个部分内容少于500字
**原因**: AI没有生成足够详细的内容
**解决**: 检查prompt中的内容要求

### 修复步骤

1. **识别问题**: 运行 `npm run format:check`
2. **分析原因**: 查看错误日志
3. **修复问题**: 更新prompt或代码
4. **验证修复**: 运行 `npm run format:test`
5. **重新锁定**: 运行 `npm run format:lock`

## 📈 监控指标

### 关键指标
- 格式合规率: 目标100%
- 表格数量正确率: 目标100%
- 图表数量正确率: 目标100%
- 内容长度达标率: 目标100%

### 告警阈值
- 错误数量: > 3个
- 警告数量: > 10个
- 格式锁定状态: 必须为锁定

## 📝 日志文件

### 监控日志
- **文件**: `logs/format-monitor.log`
- **内容**: 监控检查结果、错误、警告
- **轮转**: 建议每周轮转一次

### 格式锁定文件
- **文件**: `FORMAT_LOCK.json`
- **内容**: 锁定配置、时间、版本
- **更新**: 每次格式修改后更新

---
**最后更新**: 2025-01-27
**维护者**: AI Assistant
**状态**: 已锁定，禁止修改
